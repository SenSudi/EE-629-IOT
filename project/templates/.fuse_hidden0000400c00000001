{% extends 'baseline.html' %}

{% load static %}

{% block table_pallet %}
	<div class="top-spacer"></div>
	{% for phase in phases %}
    <div class="phase-div" id="{{phase.title}}">
		<div class="phase-header" style="background-color:#dad8d8;margin-bottom:15px;height:40px;padding-top:5px;">
			<table style="width:25%;margin-left:10px;margin-top:5px !important;">
              <thead style="">
                <tr style="vertical-align:middle;">
                  <th style="width:5%;"><i class="min-max-btn min-max fa fa-plus" style="padding-right:10px;"></i></th>
                  <th style="width:120px;"><span class="min-max-btn-future" style="font-size:15px;letter-spacing:3px;width:100px !important;display:inline;padding-left:25px; margin-top:5px;">
                  <b class="type-label">{{phase.title|title}}</b>
                </span></th>
                  <th style="min-width:25%;"><span class="add-record-btn" style="margin-left:15px;cursor:pointer;padding-top:7px;">Add Task <i class="fa fa-plus" style="margin-left:5px;"></i> 
                </span></th>
                <th style="min-width:25%;"><span class="label label-rouded label-success"></span></th>
                </tr>
              </thead>
            </table>
		</div>
    
      <table class="task-table" style="margin-left:10px;">
        <thead style="background-color:#dad8d8;" colspan="14">
          <tr>
            <th class="text-center" width="100">Status</th>
            <!-- <th  class="text-center" width="100">Details</th> -->
            <th class="text-left" width="390">Title</th>
            <th class="text-center" width="100">Tier</th>
            <th class="text-center" colspan="3">Session Controls</th>
            <th class="text-center" width="160">Current Session</th>
            <th class="text-center" width="100">In Progress</th>
            <th class="text-center" width="100">Complete</th>
            <th class="text-center" width="100">Skip</th>
            <th class="text-center" width="100">Total Time</th>
          </tr>
        </thead>
        <tbody>
        {% for task in phase.task_item_set.all %}
          {% if task.project == project %}
          <tr class="task" style="background-color:white;" draggable="true" id="{{task.id}}">
            <td class="text-center task-status"><i class="fa fa-circle"></i></td>
            <!-- <td class="text-center"><i class="fa fa-bars"></i></td> -->
            <td class="text-left task-title">{{task.title|title}}</td>
            <td class="text-center">I</td>
            <td class="text-center" style="color:green;"><i class="fa fa-play"></i></td>
            <td class="text-center"><i class="fa fa-pause"></i></td>
            <td class="text-center" style="color:red;"><i class="fa fa-stop"></i></td>
            <td class="text-center session-timer">00:00</td>
            <td class="text-center" style="color:orange;"><i class="fa fa-circle"></i></td>
            <td class="text-center" style="color:blue;"><i class="fa fa-check"></i></td>
            <td class="text-center" style="color:red;"><i class="fa fa-minus"></i></td>
            <td class="text-center tsk-duration" contenteditable="true">
            	<!-- var seconds = Math.floor( (t/1000) % 60 );
				var minutes = Math.floor( (t/1000/60) % 60 );
				var hours = Math.floor( (t/(1000*60*60)) % 24 );
				var days = Math.floor( t/(1000*60*60*24) ); -->
				{{task.tsk_duration}}
            </td>
            <td class="session" hidden>{{task.session}}</td>
          </tr>
          {% endif %}
        {% endfor %}
        </tbody>
      </table>
      <br>
    </div>
	{% endfor %}

<!-- DETAILS MODAL -->

  <div id="details-modal" class="modal fade" role="dialog" style="margin-top:60px;">
    <div class="modal-dialog" style="background-color:white;max-height:80%;width:80vw;margin-left:10vw;">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h3 class="modal-title text-center"></h3>
      </div>
      <div class="modal-body" id="details-modal-body" style="overflow-y:scroll;">
      <span class="tsk-status"></span><br>
      <span class="tsk-tier"></span><br>
      <span class="tsk-help-base"></span><br><br>
      <span class="tsk-base-cmd"></span><br><br>
      <span class="tsk-est-time"></span><br>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>

{% endblock %}


<!-- <form method='POST' action='/new_task/' class='post-form'>{% csrf_token %}<div class='form-group'><label for='help_base'>Basic Help</label><div class='input-group'><div class='input-group-addon'></div><input id='help_base' type='text' name='help_base'></div></div><div class='form-group'><label for='base_cmd'>Template Command</label><div class='input-group'><div class='input-group-addon'></div><input type='text' id='base_cmd' name='base_cmd'></div></div></form> -->




<!-- <tr class='task' style='background-color:white;' draggable='true' id='"+task_id_"'>
            <td class='text-center task-status'><i class='fa fa-circle'></i></td>
            
            <td class='text-left task-title'>{{task.title|title}}</td>
            <td class="text-center">I</td>
            <td class="text-center" style="color:green;"><i class="fa fa-play"></i></td>
            <td class="text-center"><i class="fa fa-pause"></i></td>
            <td class="text-center" style="color:red;"><i class="fa fa-stop"></i></td>
            <td class="text-center session-timer">00:00</td>
            <td class="text-center" style="color:orange;"><i class="fa fa-circle"></i></td>
            <td class="text-center" style="color:blue;"><i class="fa fa-check"></i></td>
            <td class="text-center" style="color:red;"><i class="fa fa-minus"></i></td>
            <td class="text-center tsk-duration" contenteditable="true">
            	
				{{task.tsk_duration}}
            </td>
            <td class="session" hidden>{{task.session}}</td>
          </tr> -->




{% block scripts %}
<script src="{% static 'elite/js/mask.js' %}"></script>
<script type="text/javascript">
  String.prototype.capitalize = function() {
    return this.charAt(0).toUpperCase() + this.slice(1);
  }

  $(document).ready(function(){

  	var b_op = '<b>'
  	var b_cl = '</b>'

    $('.task-title').css('cursor','pointer');
    $('.task-status').css('cursor','pointer');

    function initState(){
      $('.task-table').attr('hidden','true');
    }

    //initState();

    function addTask(phase) {
    	var modal = $('#details-modal');
        modal.modal('show');

        modal.find('.modal-title').empty().append(b_op+'New Task'+b_cl);
        modal.find('.modal-body').empty().append("<form method='POST' action='/new_task/' class='post-form' id='new_task_form'>{% csrf_token %}<div class='form-group'><label for='tsk_title'>Task Title</label><div class='input-group'><div class='input-group-addon'></div><input type='text' id='tsk_title' name='tsk_title'></div></div><div class='form-group'><label for='help_base'>Basic Help</label><div class='input-group'><div class='input-group-addon'></div><textarea id='help_base' name='help_base'></textarea></div></div><div class='form-group'><label for='base_cmd'>Template Command</label><div class='input-group'><div class='input-group-addon'></div><input type='text' id='base_cmd' name='base_cmd'></div></div><input type='hidden' value='"+phase+"' name='phase'></form>");
        modal.find('.modal-dialog').css('width','50vw');
        modal.find('.modal-dialog').css('margin-left','25vw');
        modal.find('#help_base').css('width','100%');
        modal.find('#base_cmd').css('width','100%');
        modal.find('.modal-footer').prepend('<button type="submit" id="add-task" class="btn btn-success waves-effect waves-light m-r-10">Add Task</button>');
        //modal.find('.modal-footer').append('<script>function submitNewTask(){ 	console.log("here");var phase = $("#new_task_form").find("input[name=phase]").val();var title = $("#new_task_form").find("input[name=tsk_title]").val(); var help = $("#new_task_form").find("input[name=help_base]").val();var cmd = $("#new_task_form").find("input[name=base_cmd]").val();var data = {"csrfmiddlewaretoken":"{{csrf_token}}","phase":phase,"title":tsk_title,"help_base":help,"base_cmd":cmd};var url = "/new_task/";$.post(url,data,function(returned){console.log(returned);});}</'+'script>');
    }

    //$('#add-task').click(

    // function submitNewTask(){
    // 	console.log('here');
    // 	var phase = $('#new_task_form').find('input[name=phase]').val();
    // 	var help = $('#new_task_form').find('input[name=help_base]').val();
    // 	var cmd = $('#new_task_form').find('input[name=base_cmd]').val();
    // 	var data = {'csrfmiddlewaretoken':'{{csrf_token}}','phase':phase,'help_base':help,'base_cmd':cmd};
    // 	var url = '/new_task/';
    // 	$.post(url,data,function(returned){
    // 		console.log(returned);
    // 	});
    // }//);


    function newTaskToTable() {

    }



    $('.add-record-btn').click(function(){
    	var phase = $(this).closest('.phase-div').attr('id');
    	addTask(phase);
    });

    function showTable(table){
      table.removeAttr('hidden');
    }

    function hideTable(table){
      table.attr('hidden','hidden');
    }



    $('.min-max-btn').click(function(){
      var table = $(this).closest('.phase-div').find('.task-table');
      //console.log('here')
      //console.log(table);
      //console.log(table.attr('hidden'))
      if(table.attr('hidden')){
        showTable(table);
      }else{
        //console.log('here')
        hideTable(table);
      }
    });

    function detailsModal(row){
      var task_id = row.attr('id')
      var status_icon = row.find('.task-status').html();
      var url = '/task_info/';
      var data = {'csrfmiddlewaretoken':'{{csrf_token}}','task_id':task_id};
      $.post(url,data,function(returned){
        //console.log(returned['task']);
        var task = returned['task'];
        var created = task['created'];
        var base_command = task['base_command'];
        var est_time = task['est_time'];
        var exec_cmd = task['exec_cmd'];
        var exec_duration = task['exec_duration'];
        var help_base = task['help_base'].capitalize();
        var status = task['status'].capitalize();
        var title = task['title'];

        if (returned != 'Not Authorized') {
          var modal = $('#details-modal');
          modal.modal('show');
          modal.find('.modal-title').empty().append('<b>'+title+'</b>');
          modal.find('.tsk-status').empty().append('<b>Status:</b> ' + status + ' ' + '<i style="color:grey;" class="fa fa-circle s-active"></i>' + ' | <i style="color:orange;" class="fa fa-circle"></i> | <i style="color:green;" class="fa fa-check"></i> | <i style="color:red;" class="fa fa-minus"></i>');
          modal.find('.tsk-tier').empty().append('<b>Task Tier:</b> '+'I - Yellow Belt');
          modal.find('.tsk-help-base').empty().append('<b>Basic Help:</b> '+help_base);
          modal.find('.tsk-est-time').empty().append('<b>Estimated Duration: </b>'+est_time);
          modal.find('.tsk-base-cmd').empty().append('<b>Command Template: </b>'+base_command);
          modal.find('i').css('cursor','pointer');
          modal.find('.tsk-status').children('.fa').css('opacity','.3');
          $('.s-active').css('opacity','1');
        }
        $('i').click(function(){
            modal.find('.tsk-status').children('.fa').css('opacity','.3');
            $(this).css('opacity','1');
          });
      });
    }

    $('.task-title').click(function(){
      var row = $(this).closest('tr');
      detailsModal(row);
    });
    $('.task-status').click(function(){
      var row = $(this).closest('tr');
      detailsModal(row);
    });
  });
</script>

<script type="text/javascript">
$(document).ready(function(){




  function startSessionTimer() {
  	var startTime = new Date();
  	return {
  		'startTime': startTime 
  	};
  }

  function updateSessionTimer(startTime) {
  	t = Date.parse(startTime) + Date.parse(new Date());
  	var seconds = Math.floor( (t/1000) % 60 );
	var minutes = Math.floor( (t/1000/60) % 60 );
	var hours = Math.floor( (t/(1000*60*60)) % 24 );
	var days = Math.floor( t/(1000*60*60*24) );
	return {
	'total': t,
	'days': days,
	'hours': hours,
	'minutes': minutes,
	'seconds': seconds
	};
  }

  function sessionHandler(task, task_id, start_time){
    var sessionName = '__'+task_id+'SessionTimer';
	var sessionTimer = task.data(sessionName); 
	if (sessionTimer) {
		clearInterval(sessionTimer);
		task.removeData(sessionName);
	} else {
		var sessionTimer = setInterval(function () {
			    
				var session = updateSessionTimer(start_time);
			
			task.find('.session-timer').text(session.hours+':'+session.minutes+':'+session.seconds);
		},1000);
		task.data(sessionName, sessionTimer);
	}
  }

  $('.fa-play').click(function(){
  	var play = $(this);
    var task = $(this).closest('tr');
    var task_id = $(this).closest('tr').attr('id');
    //console.log(task_id);
    var data = {'csrfmiddlewaretoken':'{{csrf_token}}','task_id':task_id};
    var url = '/startsession/'
    if (!play.attr('disabled')) {
    	$.post(url,data,function(returned){
	    	if (returned != 'Task already has session!') {
			    sessionHandler(task,task_id,returned)
			} else {
				console.log(returned);
				var new_url = '/getsession/'
				$.post(new_url, data, function(returned){
					sessionHandler(task,task_id,returned)
				});
			}
		});
		play.attr('disabled');
    }    
  });

  $('.fa-pause').click(function(){
  	task = $(this).closest('.task');
    task_id = $(this).closest('tr').attr('id');
    var data = {'csrfmiddlewaretoken':'{{csrf_token}}','task_id':task_id};
    var url = '/pausesession/'
    $.post(url,data,function(returned){
      console.log(returned);
      sessionHandler(task, task_id)
    });
  });

  $('.fa-stop').click(function(){
    task_id = $(this).closest('tr').attr('id');
    var data = {'csrfmiddlewaretoken':'{{csrf_token}}','task_id':task_id};
    var url = '/stopsession/'
    $.post(url,data,function(returned){
      console.log(returned);
    });
  });


  $('.tsk-duration').click(function(){
  	// var options = {
  	// 	$el: $(this),
  	// 	mask: 'HH:mm',
  	// 	errorFunction: function (isValid){
  	// 		if (isValid == False) {
  	// 			$(this).parent().css('border', '1px solid red');
  	// 		} else {
  	// 			$(this).parent().css('border', '1px solid green');
  	// 		}
  	// 	},
  	// 	defaultValue: '00:00',
  	// 	isUtc: false,
  	// }
  	//Mask.newMask(options);
  });

});
</script>
<script type="text/javascript">
 	function submitNewTask(){
 		console.log("here");
 		var phase = $("#new_task_form").find("input[name=phase]").val();
 		var tsk_title = $("#new_task_form").find("input[name=tsk_title]").val(); 
 		var help = $("#new_task_form").find("input[name=help_base]").val();
 		var cmd = $("#new_task_form").find("input[name=base_cmd]").val();
 		var data = {
 			"csrfmiddlewaretoken":"{{csrf_token}}",
 			"phase":phase,
 			"title":tsk_title,
 			"help_base":help,
 			"base_cmd":cmd
 		};
 		console.log(data);
 		var url = "/new_task/";
 		$.post(url,data,function(returned){
 			console.log(returned);
 		});
 	}
 	
 	$('#add-task').click(function(){
 		submitNewTask();
 		//$('#details-modal').modal('hide');
 	});
 </script>
{% endblock %}